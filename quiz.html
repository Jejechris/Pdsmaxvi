<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Kuis Perpisahan - PDSMAXVI</title>
  <meta name="description" content="Kuis seru untuk mengenal para kakak Angkatan 2025. Kumpulkan skor dan kirim pesan!">
  <link rel="canonical" href="quiz.html">
  <meta property="og:title" content="Kuis Perpisahan - PDSMAXVI">
  <meta property="og:description" content="Kuis seru dan kirim pesan untuk kakak-kakak.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="pdsmaxvi.jpg">
  <meta property="og:url" content="quiz.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Kuis Perpisahan - PDSMAXVI">
  <meta name="twitter:description" content="Kuis seru dan kirim pesan untuk kakak-kakak.">
  <meta name="twitter:image" content="pdsmaxvi.jpg">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5c3c92">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <button id="music-control" aria-label="Putar musik latar" title="Play / Pause">🎵</button>
  <audio id="background-music" src="03.mp3" loop></audio>
  <button id="back-to-top" aria-label="Kembali ke atas" title="Back to top">↑</button>
  <!-- NAV -->
  <nav>
    <div class="nav-inner container">
      <div class="logo"><a href="index.html" style="text-decoration:none;color:inherit;"><h4>PDSMAXVI</h4></a></div>

      <ul class="nav-links" aria-hidden="true">
        <li><a href="index.html">Beranda</a></li>
        <li><a href="pesan.html">Pesan</a></li>
        <li><a href="struktur.html">Pengurus</a></li>
        <li><a href="quiz.html">Kuis</a></li>
        <li><a href="galeri.html">Timeline</a></li>
        <li><a href="awards.html">Awards</a></li>
        <li><a href="estafet.html">Estafet</a></li>
        <li><a href="surat-unik.html">Surat Unik</a></li>
      </ul>

      <div class="hamburger" role="button" aria-label="Menu">
        <div class="line1"></div><div class="line2"></div><div class="line3"></div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main>
    <section class="container-section">
      <div class="container">
        <div class="page-header" data-aos="fade-up">
          <h2>Games: Tebak Siapakah Kakak Ini?</h2>
          <p>Jawab pertanyaan, kumpulkan skor, lalu kirim hasil & pesanmu ke Google Form kami.</p>
        </div>

        <div class="quiz-container" data-aos="fade-up">
          <!-- Quiz Header -->
          <div class="quiz-meta">
            <div id="question-count" style="font-size:0.95rem;">
              <span style="opacity:0.8;">Soal</span> <strong>1/10</strong>
            </div>
            <div id="timer-text" style="font-size:0.95rem;">
              ⏱ <strong>20</strong> detik
            </div>
          </div>
          
          <!-- Hearts -->
          <div class="hearts" id="hearts">❤❤❤</div>
          
          <!-- Progress Bar -->
          <div class="quiz-progress">
            <div class="bar" id="progress-bar" style="width:0%"></div>
          </div>

          <!-- Quiz Content -->
          <div id="multiple-choice-quiz">
            <div id="question-text" style="font-size:1.25rem; font-weight:700; margin-bottom:2rem; color:#2d2d2d; line-height:1.6;">
              Memuat pertanyaan...
            </div>
            <div id="options-container" style="display:grid; gap:12px; margin-bottom:1rem;"></div>
            <div style="display:flex; justify-content:center; margin-top:1.5rem;">
              <button id="next-btn" class="next-btn" style="display:none;">Lanjut →</button>
            </div>
          </div>

          <div id="final-section" style="display:none; margin-top:1rem;">
            <div id="result-text" style="font-weight:700; margin-bottom:.75rem;"></div>
            <div id="badge-wrap" style="margin-bottom:10px;"></div>
            <div class="summary">
              <div id="summary-detail"></div>
              
              <!-- Toggle between Global and Local -->
              <div style="margin-top:16px; text-align:center;">
                <button id="toggle-global" class="toggle-btn active" style="margin:0 4px; padding:8px 16px; border:2px solid #9c27b0; background:#9c27b0; color:#fff; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.3s;">
                  🌍 Global Top 20
                </button>
                <button id="toggle-local" class="toggle-btn" style="margin:0 4px; padding:8px 16px; border:2px solid #e0d7f3; background:#fff; color:#6a1b9a; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.3s;">
                  📱 Lokal (Perangkat Ini)
                </button>
              </div>
              
              <h4 id="leaderboard-title" style="margin-top:16px;">🌍 Global Leaderboard (Realtime)</h4>
              <div id="firebase-status" style="font-size:0.85rem; color:#666; margin-bottom:8px; text-align:center;"></div>
              <ol id="leaderboard" class="leaderboard"></ol>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button id="share-btn" class="submit-btn">Bagikan Hasil</button>
              <button id="restart-btn" class="next-btn">Main Lagi</button>
            </div>
            <hr style="margin: 1rem 0;">
            <h3>Simpan Skormu ke Leaderboard Global:</h3>
            <input type="text" id="user-name" placeholder="Nama lengkapmu..." class="text-input" style="margin-top:.6rem;">
            <button id="submit-btn" class="submit-btn" style="margin-top:.8rem;">💾 Simpan ke Leaderboard</button>
            <p class="kv-muted" style="margin-top:.6rem;">Skormu akan tersimpan di leaderboard global untuk semua device.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
  <p>&copy; 2025 Perpisahan Angkatan XII - Semua Hak Cipta Dilindungi</p>
  
  <div class="footer-links">
    <a href="index.html">Beranda</a> |
    <a href="pesan.html">Pesan</a> |
    <a href="quiz.html">Kuis</a>
  </div>

  <div class="social-icons">
    <a href="#"><i class="fab fa-instagram"></i></a>
    <a href="#"><i class="fab fa-youtube"></i></a>
    <a href="#"><i class="fab fa-whatsapp"></i></a>
  </div>
</footer>

  <!-- QUIZ LOGIC -->
  <script>
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const nextBtn = document.getElementById('next-btn');
    const timerText = document.getElementById('timer-text');
    const multipleChoiceQuiz = document.getElementById('multiple-choice-quiz');
    const finalSection = document.getElementById('final-section');
    const resultText = document.getElementById('result-text');
    const submitBtn = document.getElementById('submit-btn');
    const questionCountEl = document.getElementById('question-count');
    const progressBar = document.getElementById('progress-bar');
    const heartsEl = document.getElementById('hearts');
    const badgeWrap = document.getElementById('badge-wrap');
    const summaryDetail = document.getElementById('summary-detail');
    const leaderboardEl = document.getElementById('leaderboard');
    const shareBtn = document.getElementById('share-btn');
    const restartBtn = document.getElementById('restart-btn');
    const toggleGlobalBtn = document.getElementById('toggle-global');
    const toggleLocalBtn = document.getElementById('toggle-local');
    const leaderboardTitle = document.getElementById('leaderboard-title');
    const firebaseStatus = document.getElementById('firebase-status');

    const TIME_LIMIT = 20; // detik per soal
    const TOTAL_QUESTIONS = 10;
    const MAX_HEARTS = 3;

    let allQuestions = [];
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let correctCount = 0;
    let timeLeft = TIME_LIMIT;
    let timer;
    let hearts = MAX_HEARTS;
    let totalTime = 0;
    let firebaseInitialized = false;
    let firebaseQuery = null;
    let showingGlobal = true;

    function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

    function renderHearts(){
      heartsEl.innerHTML = '';
      for(let i=0;i<MAX_HEARTS;i++){
        const span = document.createElement('span');
        span.className = 'heart';
        span.textContent = i < hearts ? '❤' : '♡';
        heartsEl.appendChild(span);
      }
    }

    async function loadQuestions(){
      try {
        const res = await fetch('questions.json');
        if (!res.ok) throw new Error('Failed to fetch questions');
        const data = await res.json();
        allQuestions = data.questions;
        quizQuestions = shuffle([...allQuestions]).slice(0, TOTAL_QUESTIONS);
      } catch (error) {
        console.error('Error loading questions:', error);
        // Fallback questions if JSON fails to load
        allQuestions = [
          { "type": "multi", "category": "acara", "question": "Saat acara Retreat 2025, siapakah kakak yang jadi 'Games Master' paling heboh dan kreatif? (Pilih 2)", "options": ["Andre Wijaya","Kevin Jonathan","David Hutama","Michael Tan"], "answer": ["Kevin Jonathan","Andre Wijaya"] },
          { "type": "mcq", "category": "musik", "question": "Kakak yang suaranya paling khas dan sering jadi WL utama adalah...", "options": ["Maria Grace","Sari Dewi","Jessica Lim","Grace Natalia"], "answer": ["Maria Grace"] },
          { "type": "mcq", "category": "pengurus", "question": "Siapakah Ketua PDSMAXVI angkatan 2025?", "options": ["Kezia Amanda P.D.","Jonathan Lee","Samuel P.","Raphael Dimas W."], "answer": ["Kezia Amanda P.D."] },
          { "type": "mcq", "category": "pengurus", "question": "Siapakah yang bertugas sebagai Bendahara angkatan?", "options": ["Cindy Aulia","Raphael Dimas W.","Felicia Angel","Putri Lestari"], "answer": ["Raphael Dimas W."] },
          { "type": "bool", "category": "doa", "question": "Samuel P. paling sering memimpin doa pembuka.", "options": ["Benar","Salah"], "answer": ["Benar"] },
          { "type": "mcq", "category": "musik", "question": "Siapakah koordinator sie musik?", "options": ["Gracia Yolanda D.S.","Hayu Kinanthi W.","Elnathan Hamonangan M.","Marco Oktavianus"], "answer": ["Gracia Yolanda D.S."] },
          { "type": "mcq", "category": "perkap", "question": "Siapakah yang sering bertanggung jawab pada perkap?", "options": ["Jesen Christofer S.","Rafael Davino H.","Andre Wijaya","David Hutama"], "answer": ["Jesen Christofer S."] },
          { "type": "mcq", "category": "pengurus", "question": "Siapakah yang menjadi Sekretaris angkatan 2025?", "options": ["Violetta Theona Putri","Kezia Amanda","Raphael Dimas W.","Putri Lestari"], "answer": ["Violetta Theona Putri"] },
          { "type": "mcq", "category": "proker", "question": "Program kerja angkatan kami yang paling berkesan adalah...", "options": ["Retret Tahunan","Natal Bersama Panti","Paskah Sekolah","Semua Benar"], "answer": ["Semua Benar"] },
          { "type": "mcq", "category": "desain", "question": "Siapakah yang jago desain grafis untuk poster PDSMAXVI?", "options": ["Jessica Lim","Putri Lestari","Felicia Angel","Cindy Aulia"], "answer": ["Jessica Lim"] },
          { "type": "mcq", "category": "doa", "question": "Siapa yang sering jadi pengurus Sie Doa?", "options": ["Marco Oktavianus","Meisy Arbatinsia","Amadea Rosana K.","Baptist Mulya Radja S."], "answer": ["Meisy Arbatinsia"] },
          { "type": "mcq", "category": "acara", "question": "Siapakah Ketua Koordinator Sie Acara?", "options": ["Amadea Rosana K.","Marco Oktavianus","Gracia Yolanda D.S.","Jesen Christofer S."], "answer": ["Amadea Rosana K."] },
          { "type": "mcq", "category": "fun", "question": "Siapa yang biasanya paling semangat waktu pesan makanan?", "options": ["David Hutama","Daniel Suryo","Samuel P.","Budi Santoso"], "answer": ["David Hutama"] },
          { "type": "mcq", "category": "fun", "question": "Kakak yang sering telat tapi punya alasan kreatif adalah...", "options": ["Kevin Jonathan","Andre Wijaya","Michael Tan","Raphael Dimas W."], "answer": ["Andre Wijaya"] }
        ];
        quizQuestions = shuffle([...allQuestions]).slice(0, TOTAL_QUESTIONS);
      }
    }

    function startQuiz(){
      if (!quizQuestions || quizQuestions.length === 0) {
        questionText.textContent = 'Error: Gagal memuat pertanyaan. Refresh halaman.';
        console.error('No questions available');
        return;
      }
      
      currentQuestionIndex = 0; score = 0; correctCount = 0; hearts = MAX_HEARTS; totalTime = 0;
      multipleChoiceQuiz.style.display = 'block';
      finalSection.style.display = 'none';
      renderHearts();
      showQuestion();
    }

    function resetState(){
      while (optionsContainer.firstChild) {
        optionsContainer.removeChild(optionsContainer.firstChild);
      }
      nextBtn.style.display = 'none';
    }

    function updateProgress(){
      const total = quizQuestions.length || 1;
      const current = currentQuestionIndex + 1;
      questionCountEl.innerHTML = `<span style="opacity:0.8;">Soal</span> <strong>${current}/${total}</strong>`;
      const pct = ((currentQuestionIndex)/total) * 100;
      progressBar.style.width = pct + '%';
    }

    function showQuestion(){
      if (!quizQuestions || quizQuestions.length === 0) {
        questionText.textContent = 'Error: Tidak ada pertanyaan yang tersedia.';
        return;
      }
      
      if (currentQuestionIndex >= quizQuestions.length) {
        showFinalSection();
        return;
      }
      
      const q = quizQuestions[currentQuestionIndex];
      if (!q) {
        questionText.textContent = 'Error: Pertanyaan tidak ditemukan.';
        return;
      }
      
      resetState();
      updateProgress();
      
      questionText.textContent = q.question;
      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.addEventListener('click', ()=> selectAnswer(btn, q));
        optionsContainer.appendChild(btn);
      });
      timeLeft = TIME_LIMIT;
      timerText.innerHTML = `⏱ <strong>${timeLeft}</strong> detik`;
      clearInterval(timer); startTimer();
    }

    function startTimer(){
      timer = setInterval(()=>{
        timeLeft--;
        timerText.innerHTML = `⏱ <strong>${timeLeft}</strong> detik`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          timerText.innerHTML = `⏱ <strong style="color:#f44336;">Habis!</strong>`;
          const q = quizQuestions[currentQuestionIndex];
          if (q) {
            Array.from(optionsContainer.children).forEach(b=>{
              b.disabled = true;
              if (q.answer.includes(b.textContent)) b.classList.add('correct');
            });
          }
          nextBtn.style.display = 'inline-block';
        }
      }, 1000);
    }

    function lockOptions(){
      const q = quizQuestions[currentQuestionIndex];
      if (!q) return;
      Array.from(optionsContainer.children).forEach(b=>{
        b.disabled = true;
        if (q.answer.includes(b.textContent)) b.classList.add('correct');
        else b.classList.add('incorrect');
      });
    }

    function selectAnswer(button, q){
      if (!q) return;
      clearInterval(timer);
      const selected = button.textContent;
      const isCorrect = q.answer.includes(selected);

      // time-based scoring
      if (isCorrect){
        const bonus = Math.max(0, timeLeft);
        score += 10 + Math.floor(bonus/2);
        correctCount++;
      } else {
        hearts = Math.max(0, hearts - 1);
        renderHearts();
      }
      totalTime += (TIME_LIMIT - timeLeft);

      lockOptions();
      nextBtn.style.display = 'inline-block';
    }

    nextBtn.addEventListener('click', ()=>{
      currentQuestionIndex++;
      if (hearts <= 0 || currentQuestionIndex >= quizQuestions.length) showFinalSection();
      else showQuestion();
    });

    function computeBadges(){
      const badges = [];
      const avgTime = totalTime / Math.max(1, (currentQuestionIndex));
      if (avgTime < 8) badges.push('Cepat Tanggap');
      if ((correctCount / quizQuestions.length) >= 0.9) badges.push('Sangat Akurat');
      if (hearts === MAX_HEARTS) badges.push('Konsisten');
      return badges;
    }

    function saveLeaderboard(name, scoreVal){
      const key = 'pdsmaxvi_quiz_leaderboard';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push({ name, score: scoreVal, at: new Date().toISOString() });
      list.sort((a,b)=> b.score - a.score);
      const top10 = list.slice(0,10);
      localStorage.setItem(key, JSON.stringify(top10));
      return top10;
    }

    function renderLeaderboard(items, isGlobal = false){
      leaderboardEl.innerHTML = '';
      if (!items || items.length === 0) {
        leaderboardEl.innerHTML = '<li style="justify-content:center; color:#999;">Belum ada data</li>';
        return;
      }
      
      items.forEach((i, index)=>{
        const li = document.createElement('li');
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
        const date = i.at || i.timestamp;
        const timeAgo = date ? getTimeAgo(new Date(date)) : '';
        
        li.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:1.2rem; min-width:35px;">${medal}</span>
            <div>
              <div style="font-weight:600;">${i.name || 'Anonymous'}</div>
              ${isGlobal && timeAgo ? `<div style="font-size:0.75rem; color:#999;">${timeAgo}</div>` : ''}
            </div>
          </div>
          <span style="font-size:1.1rem; font-weight:700; color:#9c27b0;">${i.score}</span>
        `;
        leaderboardEl.appendChild(li);
      });
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'baru saja';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} menit lalu`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} jam lalu`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)} hari lalu`;
      return date.toLocaleDateString('id-ID');
    }

    function showGlobalLeaderboard() {
      showingGlobal = true;
      toggleGlobalBtn.style.background = '#9c27b0';
      toggleGlobalBtn.style.color = '#fff';
      toggleLocalBtn.style.background = '#fff';
      toggleLocalBtn.style.color = '#6a1b9a';
      leaderboardTitle.textContent = '🌍 Global Leaderboard (Realtime)';
      
      if (firebaseInitialized) {
        firebaseStatus.innerHTML = '<span style="color:#4caf50;">● Online - Auto refresh</span>';
        // Data will update automatically from Firebase listener
      } else {
        firebaseStatus.innerHTML = '<span style="color:#f44336;">⚠ Firebase not configured</span>';
        renderLeaderboard([]);
      }
    }

    function showLocalLeaderboard() {
      showingGlobal = false;
      toggleGlobalBtn.style.background = '#fff';
      toggleGlobalBtn.style.color = '#6a1b9a';
      toggleLocalBtn.style.background = '#9c27b0';
      toggleLocalBtn.style.color = '#fff';
      leaderboardTitle.textContent = '📱 Leaderboard Lokal (Perangkat Ini)';
      firebaseStatus.textContent = '';
      
      const localData = JSON.parse(localStorage.getItem('pdsmaxvi_quiz_leaderboard') || '[]');
      renderLeaderboard(localData, false);
    }

    // Toggle buttons
    toggleGlobalBtn.addEventListener('click', showGlobalLeaderboard);
    toggleLocalBtn.addEventListener('click', showLocalLeaderboard);

    function showFinalSection(){
      multipleChoiceQuiz.style.display = 'none';
      finalSection.style.display = 'block';
      const avg = totalTime / Math.max(1, currentQuestionIndex);
      const accuracy = ((correctCount / quizQuestions.length) * 100).toFixed(0);
      
      resultText.innerHTML = `
        <div style="font-size:2.5rem; margin-bottom:10px;">🎉</div>
        <div style="font-size:1.8rem; color:#6a1b9a; margin-bottom:8px;">Skor Akhir</div>
        <div style="font-size:3rem; font-weight:800; color:#9c27b0; line-height:1;">${score}</div>
      `;
      
      const badges = computeBadges();
      if (badges.length > 0) {
        badgeWrap.innerHTML = '<div style="margin:16px 0 8px; font-weight:600; color:#6a1b9a;">🏆 Pencapaian</div>' + 
          badges.map(b=>`<span class="badge-chip">✨ ${b}</span>`).join('');
      }
      
      summaryDetail.innerHTML = `
        <div style="margin-bottom:8px;"><strong>Jawaban Benar:</strong> ${correctCount} dari ${quizQuestions.length} soal (${accuracy}%)</div>
        <div style="margin-bottom:8px;"><strong>Rata-rata Waktu:</strong> ${avg.toFixed(1)} detik per soal</div>
        <div><strong>Sisa Nyawa:</strong> ${hearts} ❤</div>
      `;

      restartBtn.onclick = start;
      shareBtn.onclick = async ()=>{
        const text = `🎯 Skor kuis PDSMAXVI ku: ${score} poin!\n✅ Benar: ${correctCount}/${quizQuestions.length} (${accuracy}%)\n⏱ Waktu rata-rata: ${avg.toFixed(1)} detik\n\nCoba kamu juga!`;
        if (navigator.share) {
          try { await navigator.share({ text, url: window.location.href }); } catch {}
        } else {
          const url = `https://wa.me/?text=${encodeURIComponent(text)}%20${encodeURIComponent(window.location.href)}`;
          window.open(url, '_blank');
        }
      };
    }

    // SUBMIT → Simpan ke Leaderboard
    submitBtn.addEventListener('click', async ()=>{
      const userName = document.getElementById('user-name').value.trim();
      if (!userName) { 
        alert('Harap isi nama kamu!'); 
        return; 
      }
      
      // Disable button to prevent double submit
      submitBtn.disabled = true;
      submitBtn.textContent = '⏳ Menyimpan...';
      
      try {
        // Save to local storage
        const localItems = saveLeaderboard(userName, score);
        
        // Save to Firebase if available
        if (firebaseInitialized) {
          const avg = totalTime / Math.max(1, currentQuestionIndex);
          const saved = await saveScoreToFirebase(userName, score, {
            correctCount,
            totalQuestions: quizQuestions.length,
            avgTime: parseFloat(avg.toFixed(1)),
            hearts
          });
          
          if (saved) {
            alert(`✅ Skor tersimpan!\n\nNama: ${userName}\nSkor: ${score}\n\nCek di leaderboard global! 🎉`);
          } else {
            alert('⚠️ Gagal simpan ke Firebase, tapi tersimpan di local.');
          }
        } else {
          alert(`✅ Skor tersimpan di local!\n\nNama: ${userName}\nSkor: ${score}`);
        }
        
        // If showing local, update display
        if (!showingGlobal) {
          renderLeaderboard(localItems, false);
        }
        
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Simpan ke Leaderboard';
        
      } catch (error) {
        console.error('Error submitting:', error);
        alert('❌ Terjadi error saat menyimpan. Coba lagi!');
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Simpan ke Leaderboard';
      }
    });

    function start(){
      console.log('Starting quiz initialization...');
      
      // Initialize Firebase
      firebaseInitialized = initFirebase();
      
      // Setup Firebase listener for global leaderboard
      if (firebaseInitialized) {
        firebaseQuery = listenToLeaderboard((entries) => {
          if (showingGlobal) {
            renderLeaderboard(entries, true);
          }
        }, 20);
      }
      
      // Load questions
      loadQuestions().then(() => {
        console.log('Questions loaded successfully:', quizQuestions.length, 'questions');
        console.log('First question:', quizQuestions[0]);
        startQuiz();
      }).catch(error => {
        console.error('Failed to load questions:', error);
        alert('Gagal memuat pertanyaan. Menggunakan pertanyaan cadangan...');
        // Ensure fallback questions are loaded
        if (!quizQuestions || quizQuestions.length === 0) {
          loadQuestions().then(() => startQuiz());
        } else {
          startQuiz();
        }
      });
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (firebaseQuery) {
        stopListeningToLeaderboard(firebaseQuery);
      }
    });
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
      console.log('DOM still loading, waiting...');
      document.addEventListener('DOMContentLoaded', start);
    } else {
      console.log('DOM ready, starting immediately...');
      start();
    }
  </script>

  <script src="app.js"></script>

</body>
</html>
